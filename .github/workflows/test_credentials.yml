# Small workflow to validate notarytool credentials in CI (no build, no submit)
# Trigger manually from Actions -> Run workflow.
on:
  workflow_dispatch:

name: Test Notary Credentials

jobs:
  test-notary-credentials:
    runs-on: macos-latest
    env:
      APPLE_ID: ${{ secrets.MY_APPLE_ID }}
      TEAM_ID: ${{ secrets.MY_TEAM_ID }}
      APP_SPECIFIC_PASSWORD: ${{ secrets.MY_APP_SPECIFIC_PASSWORD }}
      KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
    steps:
      - name: Print runner / tool versions
        run: |
          xcodebuild -version
          xcrun notarytool --version || true

      - name: Create temporary keychain and add to search list
        run: |
          set -euo pipefail
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          # Ensure the temporary keychain is in the user search list so notarytool can find items
          security list-keychain -d user -s "$KEYCHAIN_PATH" "$HOME/Library/Keychains/login.keychain-db"
          security show-keychain-info "$KEYCHAIN_PATH" || true

      - name: Store notary credentials (validates Apple ID + app-specific password)
        id: store
        shell: bash
        run: |
          set -euo pipefail
          echo "Storing credentials into keychain (will fail with 401 if Apple rejects them)..."
          # This will attempt to authenticate and will fail with HTTP 401 if the credentials are invalid
          xcrun notarytool store-credentials test_notary_profile --apple-id "$APPLE_ID" --team-id "$TEAM_ID" --password "$APP_SPECIFIC_PASSWORD"
          echo "stored=ok" >> $GITHUB_OUTPUT

      - name: Verify password item in keychain
        run: |
          set -euo pipefail
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"
          echo "Keychain list:"
          security list-keychain -d user
          echo "Searching for stored generic password 'test_notary_profile' in $KEYCHAIN_PATH"
          # This command prints metadata if present; errors do not fail the job so we can inspect logs
          security find-generic-password -l "test_notary_profile" -g "$KEYCHAIN_PATH" 2>&1 || true

      - name: Clean up credentials and keychain
        if: always()
        run: |
          set -euo pipefail
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"
          echo "Removing notary profile (if present)"
          xcrun notarytool remove-credentials test_notary_profile || true
          echo "Deleting keychain $KEYCHAIN_PATH"
          security delete-keychain "$KEYCHAIN_PATH" || true